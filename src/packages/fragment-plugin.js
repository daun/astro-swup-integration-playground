import t from"@swup/plugin";function e(t,e){var r=[];return function(t,e,r){void 0===r&&(r={});var n=r.decode,o=void 0===n?function(t){return t}:n;return function(r){var n=t.exec(r);if(!n)return!1;for(var i=n[0],a=n.index,s=Object.create(null),c=function(t){if(void 0===n[t])return"continue";var r=e[t-1];s[r.name]="*"===r.modifier||"+"===r.modifier?n[t].split(r.prefix+r.suffix).map(function(t){return o(t,r)}):o(n[t],r)},u=1;u<n.length;u++)c(u);return{path:i,index:a,params:s}}}(o(t,r,e),r,e)}function r(t){return t.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function n(t){return t&&t.sensitive?"":"i"}function o(t,e,i){return t instanceof RegExp?function(t,e){if(!e)return t;for(var r=/\((?:\?<(.*?)>)?(?!\?)/g,n=0,o=r.exec(t.source);o;)e.push({name:o[1]||n++,prefix:"",suffix:"",modifier:"",pattern:""}),o=r.exec(t.source);return t}(t,e):Array.isArray(t)?function(t,e,r){var i=t.map(function(t){return o(t,e,r).source});return new RegExp("(?:".concat(i.join("|"),")"),n(r))}(t,e,i):function(t,e,o){return function(t,e,o){void 0===o&&(o={});for(var i=o.strict,a=void 0!==i&&i,s=o.start,c=void 0===s||s,u=o.end,l=void 0===u||u,f=o.encode,m=void 0===f?function(t){return t}:f,h=o.delimiter,g=void 0===h?"/#?":h,p=o.endsWith,d="[".concat(r(void 0===p?"":p),"]|$"),w="[".concat(r(g),"]"),v=c?"^":"",E=0,y=t;E<y.length;E++){var x=y[E];if("string"==typeof x)v+=r(m(x));else{var $=r(m(x.prefix)),A=r(m(x.suffix));if(x.pattern)if(e&&e.push(x),$||A)if("+"===x.modifier||"*"===x.modifier){var S="*"===x.modifier?"?":"";v+="(?:".concat($,"((?:").concat(x.pattern,")(?:").concat(A).concat($,"(?:").concat(x.pattern,"))*)").concat(A,")").concat(S)}else v+="(?:".concat($,"(").concat(x.pattern,")").concat(A,")").concat(x.modifier);else v+="+"===x.modifier||"*"===x.modifier?"((?:".concat(x.pattern,")").concat(x.modifier,")"):"(".concat(x.pattern,")").concat(x.modifier);else v+="(?:".concat($).concat(A,")").concat(x.modifier)}}if(l)a||(v+="".concat(w,"?")),v+=o.endsWith?"(?=".concat(d,")"):"$";else{var _=t[t.length-1],b="string"==typeof _?w.indexOf(_[_.length-1])>-1:void 0===_;a||(v+="(?:".concat(w,"(?=").concat(d,"))?")),b||(v+="(?=".concat(w,"|").concat(d,")"))}return new RegExp(v,n(o))}(function(t,e){void 0===e&&(e={});for(var n=function(t){for(var e=[],r=0;r<t.length;){var n=t[r];if("*"!==n&&"+"!==n&&"?"!==n)if("\\"!==n)if("{"!==n)if("}"!==n)if(":"!==n)if("("!==n)e.push({type:"CHAR",index:r,value:t[r++]});else{var o=1,i="";if("?"===t[s=r+1])throw new TypeError('Pattern cannot start with "?" at '.concat(s));for(;s<t.length;)if("\\"!==t[s]){if(")"===t[s]){if(0==--o){s++;break}}else if("("===t[s]&&(o++,"?"!==t[s+1]))throw new TypeError("Capturing groups are not allowed at ".concat(s));i+=t[s++]}else i+=t[s++]+t[s++];if(o)throw new TypeError("Unbalanced pattern at ".concat(r));if(!i)throw new TypeError("Missing pattern at ".concat(r));e.push({type:"PATTERN",index:r,value:i}),r=s}else{for(var a="",s=r+1;s<t.length;){var c=t.charCodeAt(s);if(!(c>=48&&c<=57||c>=65&&c<=90||c>=97&&c<=122||95===c))break;a+=t[s++]}if(!a)throw new TypeError("Missing parameter name at ".concat(r));e.push({type:"NAME",index:r,value:a}),r=s}else e.push({type:"CLOSE",index:r,value:t[r++]});else e.push({type:"OPEN",index:r,value:t[r++]});else e.push({type:"ESCAPED_CHAR",index:r++,value:t[r++]});else e.push({type:"MODIFIER",index:r,value:t[r++]})}return e.push({type:"END",index:r,value:""}),e}(t),o=e.prefixes,i=void 0===o?"./":o,a="[^".concat(r(e.delimiter||"/#?"),"]+?"),s=[],c=0,u=0,l="",f=function(t){if(u<n.length&&n[u].type===t)return n[u++].value},m=function(t){var e=f(t);if(void 0!==e)return e;var r=n[u],o=r.index;throw new TypeError("Unexpected ".concat(r.type," at ").concat(o,", expected ").concat(t))},h=function(){for(var t,e="";t=f("CHAR")||f("ESCAPED_CHAR");)e+=t;return e};u<n.length;){var g=f("CHAR"),p=f("NAME"),d=f("PATTERN");if(p||d)-1===i.indexOf(v=g||"")&&(l+=v,v=""),l&&(s.push(l),l=""),s.push({name:p||c++,prefix:v,suffix:"",pattern:d||a,modifier:f("MODIFIER")||""});else{var w=g||f("ESCAPED_CHAR");if(w)l+=w;else if(l&&(s.push(l),l=""),f("OPEN")){var v=h(),E=f("NAME")||"",y=f("PATTERN")||"",x=h();m("CLOSE"),s.push({name:E||(y?c++:""),pattern:E&&!y?a:y,prefix:v,suffix:x,modifier:f("MODIFIER")||""})}else m("END")}}return s}(t,o),e,o)}(t,e,i)}class i extends URL{constructor(t,e=document.baseURI){super(t.toString(),e)}get url(){return this.pathname+this.search}static fromElement(t){const e=t.getAttribute("href")||t.getAttribute("xlink:href")||"";return new i(e)}static fromUrl(t){return new i(t)}}const a=(t,r)=>{try{return e(t,r)}catch(e){throw new Error(`[swup] Error parsing path "${t}":\n${e}`)}},s=(t,e,r)=>null==t?t:`[${e}m${String(t)}[${r}m`,c=t=>`ðŸ§© ${(t=>s(t,1,22))(t)}`,u=t=>(t=>s(t,91,39))(t);class l{log(){var t=[].slice.call(arguments);const e=t.shift();console.log(c(e),...t)}warn(){var t=[].slice.call(arguments);const e=t.shift();console.warn(c(e),...t)}error(){var t=[].slice.call(arguments);const e=t.shift();console.error(c(e),...t)}logIf(t){t&&this.log(...[].slice.call(arguments,1))}warnIf(t){t&&this.warn(...[].slice.call(arguments,1))}errorIf(t){t&&this.error(...[].slice.call(arguments,1))}}window.process||(window.process={}),window.process.env||(window.process.env={});const f="development"===process.env.NODE_ENV,m=t=>{!function(t){let{rules:e,swup:r,logger:n}=t;const o=r.getCurrentUrl();e.filter(t=>t.matchesFrom(o)||t.matchesTo(o)).forEach(t=>{t.containers.forEach(t=>{const e=document.querySelector(`${t}:not([data-swup-fragment])`);if(!e)return;const r=e.getAttribute("data-swup-fragment-url");r&&f&&n?.log(`fragment url ${u(r)} for ${u(t)} provided by server`);const{url:a}=i.fromUrl(r||o);e.setAttribute("data-swup-fragment",""),e.__swupFragment={url:a,selector:t}})})}(t),function(t){let{logger:e,swup:r}=t;const n="data-swup-link-to-fragment";document.querySelectorAll(`a[${n}]`).forEach(t=>{const o=t.getAttribute(n);if(!o)return void(f&&e?.warn(`[${n}] needs to contain a valid fragment selector`));const i=document.querySelector(o);if(!i)return void(f&&e?.warn(`no element found for [${n}="${o}"]`));const a=i.__swupFragment?.url;a?g(a,r.getCurrentUrl())?f&&e?.warn(`The fragment URL of ${o} is identical to the current URL. This could mean that [data-swup-fragment-url] needs to be provided by the server.`):t.href=a:f&&e?.warn(`no fragment infos found on ${o}`)})}(t),function(t){let{logger:e}=t;document.querySelectorAll("dialog[data-swup-fragment]").forEach(t=>{t.__swupFragment?t.__swupFragment.modalShown||(t.__swupFragment.modalShown=!0,t.removeAttribute("open"),t.showModal()):f&&e?.warn("fragment properties missing on element:",t)})}(t)},h=(t,e)=>{const r=t.__swupFragment?.url;return!!r&&g(r,e)},g=(t,e)=>p(t)===p(e),p=t=>{if(!t.trim())return t;const e=i.fromUrl(t);return e.searchParams.sort(),((r=e.pathname).endsWith("/")?r.slice(0,-1):r)+e.search;var r},d=t=>{const e=t.from.url,r=t.to.url;if(e&&r)return{from:e,to:r}},w=t=>{if(!t.fragmentVisit)return;const{rule:e,containers:r}=t.fragmentVisit;e.name&&r.forEach(t=>{document.querySelector(t)?.classList.add(`to-${e.name}`)})},v=(t,e)=>e.find(e=>e.matches(t));function E(t){let{swup:e}=t;const{fragmentVisit:r}=e.visit;return!!r&&r.containers.every(t=>"template"===document.querySelector(t)?.tagName?.toLowerCase())}class y{constructor(t,e,r,n,o){this.matchesFrom=void 0,this.matchesTo=void 0,this.from=void 0,this.to=void 0,this.containers=void 0,this.name=void 0,this.from=t||"",this.to=e||"",n&&(this.name=String(n).toLowerCase().replace(/[\s/_.]+/g,"-").replace(/[^\w-]+/g,"").replace(/--+/g,"-").replace(/^-+|-+$/g,"")||""),this.containers=this.parseContainers(r,o),f&&(o?.errorIf(!e,"Every fragment rule must contain a 'to' path",this),o?.errorIf(!t,"Every fragment rule must contain a 'from' path",this)),this.matchesFrom=a(t),this.matchesTo=a(e)}parseContainers(t,e){if(!Array.isArray(t))return f&&e?.error("Every fragment rule must contain an array of containers",this),[];const r=t.map(t=>t.trim());return r.forEach(t=>{const r=this.validateSelector(t);r instanceof Error&&e?.error(r)}),[...new Set(r)]}validateSelector(t){return t.startsWith("#")?!t.match(/\s|>/)||new Error(`fragment selectors must not be nested: ${t}`):new Error(`fragment selectors must be IDs: ${t}`)}matches(t){return!1!==this.matchesFrom(t.from)&&!1!==this.matchesTo(t.to)}}const x=function(t){const e=d(t);e&&v(e,this.rules)&&(t.scroll.reset=!1)},$=function(t){try{const e=this,r=d(t);if(!r)return Promise.resolve();const n=e.getFragmentVisit(r,e.logger);return n?(t.fragmentVisit=n,f&&e.logger?.log(`fragment visit: ${u(t.fragmentVisit.containers.join(", "))}`),t.scroll.reset=!1,t.animation.scope=t.fragmentVisit.containers,t.containers=t.fragmentVisit.containers,t.animation.selector=t.fragmentVisit.containers.join(","),w(t),Promise.resolve()):Promise.resolve()}catch(t){return Promise.reject(t)}},A=function(t,e){t.fragmentVisit&&E(this)&&(f&&this.logger?.log(`${u("out")}-animation skipped for ${u(t.fragmentVisit?.containers.toString())}`),e.skip=!0)},S=function(t,e){t.fragmentVisit&&E(this)&&(f&&this.logger?.log(`${u("in")}-animation skipped for ${u(t.fragmentVisit?.containers.toString())}`),e.skip=!0)},_=function(t,e){if(t.trigger.el||!t.to.url)return;const r=this.swup.cache.get(t.to.url);r&&r.fragmentHtml&&(e.page.html=r.fragmentHtml,f&&this.logger?.log(`fragment cache used for ${u(t.to.url)}`))},b=function(t){w(t),m(this),(t=>{let{swup:e,logger:r}=t;const n=e.getCurrentUrl(),o=e.cache,i=o.get(n);if(!i)return;const a=(new DOMParser).parseFromString(i.html,"text/html"),s=[],c=Array.from(document.querySelectorAll("[data-swup-fragment]")).filter(t=>!t.matches("template")&&!h(t,n));c.length&&(e.options.cache?(c.forEach(t=>{if(null!=t.querySelector("[data-swup-fragment]"))return;const e=t.__swupFragment?.url;if(!e)return void(f&&r?.warn("no fragment url found:",t));const n=t.__swupFragment?.selector;if(!n)return void(f&&r?.warn("no fragment selector found:",t));const i=o.get(e);if(!i)return;const c=a.querySelector(n);if(!c)return;const u=(new DOMParser).parseFromString(i.html,"text/html").querySelector(n);u&&(u.setAttribute("data-swup-fragment-url",e),c.replaceWith(u),s.push(t))}),s.length&&(o.update(n,{...i,fragmentHtml:a.documentElement.outerHTML}),s.forEach(t=>{const e=t.__swupFragment?.url||"",n=t.__swupFragment?.selector||"";f&&r?.log(`updated cache with ${u(n)} from ${u(e)}`)}))):f&&r?.warn("can't cache foreign fragment elements without swup's cache"))})(this)},F=function(t){t.fragmentVisit&&(t=>{let{rule:e,containers:r}=t;e.name&&r.forEach(t=>{document.querySelector(t)?.classList.remove(`to-${e.name}`)})})(t.fragmentVisit),t.fragmentVisit=void 0};class C extends t{constructor(t){super(),this.name="SwupFragmentPlugin",this.requires={swup:">=4"},this.rules=[],this.options=void 0,this.defaults={rules:[],debug:!1},this.logger=void 0,this.options={...this.defaults,...t},f&&this.options.debug&&(this.logger=new l),this.rules=this.options.rules.map(t=>{let{from:e,to:r,containers:n,name:o}=t;return new y(e,r,n,o,this.logger)})}mount(){const t=this.swup;this.before("link:self",x),this.on("visit:start",$),this.before("animation:out:await",A),this.before("animation:in:await",S),this.before("content:replace",_),this.on("content:replace",b),this.on("visit:end",F),f&&this.logger?.warnIf(t.options.cache,"fragment caching will only work with swup's cache being active"),m(this)}unmount(){super.unmount(),this.logger=void 0,document.querySelectorAll("[data-swup-fragment]").forEach(t=>{t.removeAttribute("data-swup-fragment-url"),delete t.__swupFragment})}getFragmentVisit(t,e){const r=v(t,this.rules);if(!r)return;const n=((t,e,r)=>e.filter(e=>{const n=document.querySelector(e);return n?!h(n,t.to)||(f&&r?.log(`ignored fragment ${u(e)} as it already matches the current URL`),!1):(f&&r?.log(`fragment "${e}" missing in current document`),!1)}))(t,r.containers,e);return n.length?{rule:r,containers:n}:void 0}}export{C as default};
//# sourceMappingURL=index.module.js.map
